# 感染症動向可視化システム仕様書

## 0. 開発プロセス
本プロジェクトの開発は、以下のプロセスに従って進める。
1.  **事前確認**: 開発作業の開始前に、担当者（AIエージェントを含む）は必ず本仕様書および`TODO.md`の最新版を確認すること。
2.  **進捗の記録**: 作業が完了または中間地点に達した場合、`TODO.md`の該当項目のステータスを更新し、必要に応じて作業ログを追記する。
3.  **仕様変更管理**: 仕様に変更が生じた場合は、本仕様書を速やかに更新し、変更履歴を記録する。関連する`TODO.md`の項目も見直すこと。

---

## 1. 概要
国立感染症研究所が発表する感染症発生動向調査（IDWR）の速報データを自動的に集計・加工し、一般向けに分かりやすく可視化するWebアプリケーション。

## 2. システム構成
- **バックエンド**: Google Apps Script (GAS) Web App
  - データ取得・保存（IDWRからCSVをダウンロードしGoogle Driveに保存）
  - データ提供（APIエンドポイント経由でCSVファイルの中身をテキストとして返す）
  - URL: https://script.google.com/macros/s/AKfycbype0mQoW1TFTwHEkZY2GJ2G5niXoJwSgElUyR9xWMVtmfmxUarhhPhoTIsY3M4a2mKFw/exec
- **フロントエンド**: 静的HTML, CSS, JavaScript (GitHub Pages等でのホスティングを想定)
  - CSVデータの取得・パース
  - データの可視化（地図、グラフ、サマリー）

## 3. バックエンド仕様 (GAS Web App)

### 3.1. データ取得・更新ロジック
- **データソース**: 国立感染症研究所 IDWR速報データ (CSV)
  - 以下の主要データを取得・保存する。
    1. **定点把握疾患（週報告）**: `https://www.niid.go.jp/niid/images/idsc/idwr/data/per-sentinel-weekly-{year}-{week}.csv` (例)
    2. **ARI**: `...-ari.csv`
    3. その他必要に応じて
- **実行トリガー**:
  - 毎週金曜日の18:00に、その週のデータ更新チェックを開始する初回トリガーを設定する。
- **更新監視**:
  - 毎週金曜日 18:00 に定期実行。
  - データ更新がない場合、再試行トリガーを設定し監視を継続する（最大7日間）。

### 3.2. データ加工処理（変更）
- **GAS側でのパース廃止**: 以前はGAS側でCSVを解析しJSON化していたが、処理速度とメンテナンス性向上のため、GASは「CSVのダウンローダー兼配信サーバー」としての役割に徹する。
- **保存**: 取得したCSVデータをそのままGoogle Driveに保存する。

### 3.3. データ出力・API提供
- **アーキテクチャ**: GAS Web Appの `doGet` 関数は、リクエストパラメータに応じて保存済みのCSVファイルの中身をテキストとして返す。
- **パラメータ**:
  - `type`: `teiten` (定点), `ari` (ARI) 等、取得したいデータの種類を指定。
  - 指定がない場合は、全ての必要なデータを含むJSON（メタデータ等）またはメインのCSVを返す等の挙動とする。
- **CORS対応**: `ContentService` を使用してCORSヘッダーを付与する。

## 4. フロントエンド仕様 (HTML/CSS/JS)

### 4.1. デザイン
- 白と青を基調とした、清潔感と信頼性のあるモダンなデザイン。
- PC、スマートフォン両対応のレスポンシブレイアウト。

### 4.2. 機能
- **CSV取得・パース**:
  - GAS Web AppからCSVテキストを取得し、JavaScript側でパースする。
  - パース処理には独自のロジックまたは軽量なライブラリを使用する。
- **サマリー表示**: 注目すべき感染症の状況をカード形式で表示。流行レベルに応じて色分け（平常:青、注意:黄、警報:赤）。
- **グラフ表示**: Chart.jsを利用。
  - **棒グラフ**: 疾患ごとの都道府県別報告数。
- **ヒートマップ表示**: 日本地図SVGを配置し、都道府県ごとの流行状況を色の濃淡で表現。詳細パネルを右側に配置。
- **分析コメント表示**: ルールベース等でフロントエンド側で生成、またはGASから取得したメタデータを表示。

### 4.3. エラーハンドリング
- データ取得失敗時やパースエラー時には、適切なメッセージをユーザーに表示する。
- ローディングインジケータを実装し、ユーザー体験を損なわないようにする。